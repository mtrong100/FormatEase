<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./favicon.png" type="image/x-icon" />
    <title>Text Formatter</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        padding: 20px;
        transition: background 0.3s, color 0.3s;
      }
      textarea {
        width: 100%;
        height: 200px;
        margin-bottom: 10px;
      }
      .theme-toggle {
        display: flex;
        justify-content: end;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="theme-toggle">
        <select
          id="themeSelector"
          class="form-select w-auto"
          onchange="changeTheme()"
        >
          <option value="light">Light Mode</option>
          <option value="dark">Dark Mode</option>
          <option value="system">System Mode</option>
        </select>
      </div>
      <h2 class="mb-3 text-center">Text Formatter</h2>
      <textarea
        id="inputText"
        class="form-control"
        placeholder="Enter your text here..."
      ></textarea>
      <button class="btn btn-primary mt-2 w-100" onclick="formatText()">
        Format Text
      </button>
      <h3 class="mt-3">Output:</h3>
      <textarea id="outputText" class="form-control" readonly></textarea>
      <button class="btn btn-secondary mt-2 w-100" onclick="copyToClipboard()">
        Copy Text
      </button>
    </div>

    <script>
      function formatText() {
        let input = document.getElementById("inputText").value.trim();
        let lines = input.split("\n");
        let formattedText = "";
        let currentName = null;
        let currentContent = "";
        let introText = "";

        for (let i = 0; i < lines.length; i++) {
          let line = lines[i].trim();

          // Loại bỏ ký tự "|" nếu có ở đầu dòng
          line = line.replace(/^(\|\s*)/, "");

          // Kiểm tra nếu dòng là tên hợp lệ (chỉ gồm một từ chữ cái không chứa dấu cách)
          if (/^[A-Za-zÀ-ỹ]+$/.test(line)) {
            // Nếu introText chưa được lưu, lưu nó trước
            if (introText) {
              formattedText += introText.trim() + "\n";
              introText = "";
            }
            // Nếu có dữ liệu trước đó thì lưu lại trước khi thay tên mới
            if (currentName !== null) {
              formattedText += `${currentName}: ${currentContent.trim()}\n`;
            }
            currentName = line;
            currentContent = "";
          } else {
            // Nếu chưa gặp nhân vật nào, gom vào đoạn mở đầu
            if (currentName === null) {
              introText += (introText ? " " : "") + line;
            } else {
              // Nếu đã gặp nhân vật, nối vào nội dung của họ
              currentContent += (currentContent ? " " : "") + line;
            }
          }
        }

        // Thêm nội dung cuối cùng nếu có
        if (currentName !== null) {
          formattedText += `${currentName}: ${currentContent.trim()}\n`;
        } else if (introText) {
          formattedText += introText.trim() + "\n";
        }

        // Hiển thị kết quả
        document.getElementById("outputText").value = formattedText.trim();
      }

      function copyToClipboard() {
        let outputText = document.getElementById("outputText");
        navigator.clipboard.writeText(outputText.value).then(() => {
          alert("Text copied to clipboard!");
        });
      }

      function changeTheme() {
        const theme = document.getElementById("themeSelector").value;
        localStorage.setItem("selectedTheme", theme);
        applyTheme(theme);
      }

      function applyTheme(theme) {
        if (theme === "dark") {
          document.documentElement.setAttribute("data-bs-theme", "dark");
          document.body.style.backgroundColor = "#121212";
          document.body.style.color = "#ffffff";
        } else if (theme === "light") {
          document.documentElement.setAttribute("data-bs-theme", "light");
          document.body.style.backgroundColor = "#ffffff";
          document.body.style.color = "#000000";
        } else {
          if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            document.documentElement.setAttribute("data-bs-theme", "dark");
            document.body.style.backgroundColor = "#121212";
            document.body.style.color = "#ffffff";
          } else {
            document.documentElement.setAttribute("data-bs-theme", "light");
            document.body.style.backgroundColor = "#ffffff";
            document.body.style.color = "#000000";
          }
        }
      }

      window.onload = () => {
        const savedTheme = localStorage.getItem("selectedTheme") || "system";
        document.getElementById("themeSelector").value = savedTheme;
        applyTheme(savedTheme);
      };
    </script>
  </body>
</html>
